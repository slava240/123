<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Messenger</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .app-container { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .header { text-align: center; margin-bottom: 20px; }
        .my-id-label { font-size: 0.8em; color: #666; }
        .my-id-num { font-size: 1.8em; font-weight: bold; color: #007bff; }
        
        .tabs { display: flex; margin-bottom: 20px; background: #eee; border-radius: 10px; padding: 5px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        .tab.active { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-weight: bold; }

        .mode-content { display: none; }
        .mode-content.active { display: block; }

        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1em; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1em; transition: 0.2s; margin-top: 5px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; margin-top: 10px; }
        
        #status-bar { font-size: 0.85em; color: #888; text-align: center; margin-top: 15px; padding: 10px; border-top: 1px solid #eee; }
        .call-active { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="my-id-label">–í–∞—à –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –Ω–æ–º–µ—Ä</div>
        <div id="my-id-display" class="my-id-num">...</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('private')">–õ–∏—á–Ω—ã–π</div>
        <div class="tab" onclick="switchTab('group')">–ì—Ä—É–ø–ø–∞</div>
    </div>

    <div id="mode-private" class="mode-content active">
        <input type="number" id="direct-id-input" placeholder="–ù–æ–º–µ—Ä –∞–±–æ–Ω–µ–Ω—Ç–∞">
        <button id="call-direct-btn" class="btn btn-primary">–ü–æ–∑–≤–æ–Ω–∏—Ç—å üìû</button>
    </div>

    <div id="mode-group" class="mode-content">
        <input type="number" id="room-id-input" placeholder="–ù–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã (0-999)">
        <button id="join-group-btn" class="btn btn-primary">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É üéß</button>
        <div id="group-info" style="margin-top:10px; font-size:0.8em; color:#666; display:none;">
            –í –∫–æ–º–Ω–∞—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <span id="participants-count">0</span>
        </div>
    </div>

    <button id="hangup-btn" class="btn btn-danger" style="display:none;">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–≤—è–∑—å</button>
    
    <div id="status-bar">–°–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
</div>

<div id="remote-audios"></div>
<audio id="ringtone" loop src="https://www.soundjay.com/phone/phone-calling-1.mp3"></audio>

<script>
    // --- –ö–û–ù–§–ò–ì FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyAYzOcE7_ALO5xSJF-sq48Fc2YKgRdERDE",
        databaseURL: "https://dombase-1cbd8-default-rtdb.firebaseio.com",
        projectId: "dombase-1cbd8",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myUserNum, peer, localStream;
    let activeCalls = {}; // –î–ª—è –≥—Ä—É–ø–ø
    let currentCall;    // –î–ª—è –ª–∏—á–Ω—ã—Ö
    let isGroupMode = false;

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    function switchTab(mode) {
        if (localStream) return alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –∑–≤–æ–Ω–æ–∫!");
        document.querySelectorAll('.tab, .mode-content').forEach(el => el.classList.remove('active'));
        if (mode === 'private') {
            document.querySelector('.tab:nth-child(1)').classList.add('active');
            document.getElementById('mode-private').classList.add('active');
            isGroupMode = false;
        } else {
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('mode-group').classList.add('active');
            isGroupMode = true;
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ID
    async function init() {
        let id = localStorage.getItem('messenger_id');
        if (!id) {
            const result = await db.ref('usersCount').transaction(c => (c || 0) + 1);
            id = (result.snapshot.val() - 1).toString();
            localStorage.setItem('messenger_id', id);
        }
        myUserNum = id;
        document.getElementById('my-id-display').innerText = myUserNum;
        
        peer = new Peer('msg-v3-' + myUserNum);
        peer.on('open', () => document.getElementById('status-bar').innerText = "–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ");

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±–æ–≥–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –≤—ã–∑–æ–≤–∞
        peer.on('call', call => {
            const isIncomingGroup = call.metadata && call.metadata.isGroup;
            
            if (isIncomingGroup || confirm("–í—Ö–æ–¥—è—â–∏–π –ª–∏—á–Ω—ã–π –∑–≤–æ–Ω–æ–∫! –û—Ç–≤–µ—Ç–∏—Ç—å?")) {
                document.getElementById('ringtone').pause();
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    localStream = stream;
                    call.answer(stream);
                    handleStream(call);
                    showHangup();
                });
            }
        });
    }

    // –õ–ò–ß–ù–´–ô –ó–í–û–ù–û–ö
    document.getElementById('call-direct-btn').onclick = async () => {
        const target = document.getElementById('direct-id-input').value;
        if (!target) return;
        
        document.getElementById('status-bar').innerText = "–í—ã–∑–æ–≤...";
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const call = peer.call('msg-v3-' + target, localStream, { metadata: { isGroup: false } });
        handleStream(call);
        showHangup();
    };

    // –ì–†–£–ü–ü–û–í–û–ô –ó–í–û–ù–û–ö
    document.getElementById('join-group-btn').onclick = async () => {
        const room = document.getElementById('room-id-input').value;
        if (!room) return;

        isGroupMode = true;
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        showHangup();
        document.getElementById('group-info').style.display = 'block';

        const roomRef = db.ref(`rooms/${room}/${myUserNum}`);
        roomRef.set(true);
        roomRef.onDisconnect().remove();

        db.ref(`rooms/${room}`).on('value', snapshot => {
            const users = snapshot.val() || {};
            document.getElementById('participants-count').innerText = Object.keys(users).length;

            Object.keys(users).forEach(userId => {
                if (userId !== myUserNum && !activeCalls[userId]) {
                    const call = peer.call('msg-v3-' + userId, localStream, { metadata: { isGroup: true } });
                    handleStream(call);
                    activeCalls[userId] = call;
                }
            });
        });
    };

    function handleStream(call) {
        call.on('stream', stream => {
            if (!document.getElementById('audio-' + call.peer)) {
                const audio = document.createElement('audio');
                audio.id = 'audio-' + call.peer;
                audio.srcObject = stream;
                audio.autoplay = true;
                document.getElementById('remote-audios').appendChild(audio);
            }
        });
        currentCall = call;
    }

    function showHangup() {
        document.getElementById('hangup-btn').style.display = 'block';
        document.getElementById('status-bar').innerText = "–°–≤—è–∑—å –∞–∫—Ç–∏–≤–Ω–∞";
        document.getElementById('status-bar').classList.add('call-active');
    }

    document.getElementById('hangup-btn').onclick = () => location.reload();

    init();
</script>
</body>
</html>
