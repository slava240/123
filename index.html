<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Chat MVP</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .id-badge { background: #e7f3ff; color: #007bff; padding: 10px; border-radius: 8px; font-weight: bold; margin: 15px 0; word-break: break-all; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .controls { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-call { background: #28a745; color: white; flex-grow: 1; }
        .btn-mute { background: #6c757d; color: white; display: none; }
        .btn-hangup { background: #dc3545; color: white; display: none; }
        #status { margin-top: 15px; color: #666; font-size: 0.9em; }
        #timer { font-size: 1.5em; margin: 10px 0; color: #333; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>Аудиосвязь</h2>
    
    <div>Ваш ID:</div>
    <div id="my-id" class="id-badge">Подключение...</div>

    <input type="text" id="friend-id" placeholder="Введите ID друга">
    
    <div id="timer">00:00</div>
    <div id="status">Ожидание сети...</div>

    <div class="controls">
        <button id="call-btn" class="btn-call">Позвонить</button>
        <button id="mute-btn" class="btn-mute">Выкл. микрофон</button>
        <button id="hangup-btn" class="btn-hangup">Сбросить</button>
    </div>
</div>

<audio id="remote-audio" autoplay></audio>
<audio id="ringtone-audio" loop src="https://www.soundjay.com/phone/phone-calling-1.mp3"></audio>

<script>
    const peer = new Peer();
    let localStream;
    let currentCall;
    let timerInterval;

    const el = {
        myId: document.getElementById('my-id'),
        friendId: document.getElementById('friend-id'),
        callBtn: document.getElementById('call-btn'),
        muteBtn: document.getElementById('mute-btn'),
        hangupBtn: document.getElementById('hangup-btn'),
        status: document.getElementById('status'),
        timer: document.getElementById('timer'),
        remoteAudio: document.getElementById('remote-audio'),
        ringtone: document.getElementById('ringtone-audio')
    };

    // 1. Получаем свой ID
    peer.on('open', id => {
        el.myId.innerText = id;
        el.status.innerText = "Готов к работе";
    });

    // 2. Логика звонка
    el.callBtn.addEventListener('click', () => {
        const id = el.friendId.value;
        if (!id) return alert("Введите ID!");

        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            localStream = stream;
            const call = peer.call(id, stream);
            setupCall(call);
            el.status.innerText = "Звоним...";
        });
    });

    // 3. Входящий звонок
    peer.on('call', call => {
        el.ringtone.play();
        if (confirm("Входящий звонок! Ответить?")) {
            el.ringtone.pause();
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                localStream = stream;
                call.answer(stream);
                setupCall(call);
            });
        } else {
            el.ringtone.pause();
            call.close();
        }
    });

    function setupCall(call) {
        currentCall = call;
        
        call.on('stream', remoteStream => {
            el.remoteAudio.srcObject = remoteStream;
            startTimer();
            el.status.innerText = "Разговор...";
            el.callBtn.style.display = 'none';
            el.muteBtn.style.display = 'inline-block';
            el.hangupBtn.style.display = 'inline-block';
        });

        call.on('close', () => {
            endCall();
        });
    }

    // Кнопка Mute
    el.muteBtn.addEventListener('click', () => {
        const enabled = localStream.getAudioTracks()[0].enabled;
        if (enabled) {
            localStream.getAudioTracks()[0].enabled = false;
            el.muteBtn.innerText = "Вкл. микрофон";
            el.muteBtn.style.background = "#ffc107";
        } else {
            localStream.getAudioTracks()[0].enabled = true;
            el.muteBtn.innerText = "Выкл. микрофон";
            el.muteBtn.style.background = "#6c757d";
        }
    });

    // Кнопка Сбросить
    el.hangupBtn.addEventListener('click', () => {
        if (currentCall) currentCall.close();
        endCall();
    });

    function endCall() {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        clearInterval(timerInterval);
        el.timer.style.display = 'none';
        el.status.innerText = "Звонок завершен";
        el.callBtn.style.display = 'inline-block';
        el.muteBtn.style.display = 'none';
        el.hangupBtn.style.display = 'none';
        el.ringtone.pause();
    }

    function startTimer() {
        let sec = 0;
        el.timer.style.display = 'block';
        timerInterval = setInterval(() => {
            sec++;
            let m = Math.floor(sec / 60).toString().padStart(2, '0');
            let s = (sec % 60).toString().padStart(2, '0');
            el.timer.innerText = `${m}:${s}`;
        }, 1000);
    }
</script>
</body>
</html>
