<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger 0.1</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        body { font-family: sans-serif; background: #f4f4f9; display: flex; justify-content: center; padding: 20px; }
        .messenger-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center; }
        .my-id-block { font-size: 2em; font-weight: bold; color: #007bff; margin: 10px 0; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; text-align: center; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
        .btn-call { background: #28a745; color: white; }
        .btn-hangup { background: #dc3545; color: white; display: none; }
        #status { font-size: 0.8em; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

<div class="messenger-card">
    <h3>–í–∞—à –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π ID:</h3>
    <div id="my-id" class="my-id-block">...</div>
    
    <input type="number" id="friend-id" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥—Ä—É–≥–∞ (0, 1, 2...)">
    
    <button id="call-btn" class="btn-call">–ü–æ–∑–≤–æ–Ω–∏—Ç—å üìû</button>
    <button id="hangup-btn" class="btn-hangup">–ó–∞–≤–µ—Ä—à–∏—Ç—å ‚ùå</button>

    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã...</div>
</div>

<audio id="remote-audio" autoplay></audio>
<audio id="ringtone" loop src="https://www.soundjay.com/phone/phone-calling-1.mp3"></audio>

<script>
    // --- 2. –ù–ê–°–¢–†–û–ô–ö–ê FIREBASE ---
    // –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –î–ê–ù–ù–´–ï –ù–ê –°–í–û–ò –ò–ó –ö–û–ù–°–û–õ–ò FIREBASE!
    const firebaseConfig = {
        apiKey: "AIzaSyAYzOcE7_ALO5xSJF-sq48Fc2YKgRdERDE",
        databaseURL: "https://dombase-1cbd8-default-rtdb.firebaseio.com",
        projectId: "dombase-1cbd8",
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const myIdDisplay = document.getElementById('my-id');
    const friendIdInput = document.getElementById('friend-id');
    const callBtn = document.getElementById('call-btn');
    const hangupBtn = document.getElementById('hangup-btn');
    const status = document.getElementById('status');
    const remoteAudio = document.getElementById('remote-audio');
    const ringtone = document.getElementById('ringtone');

    let peer;
    let localStream;
    let currentCall;

    // --- 3. –õ–û–ì–ò–ö–ê –ü–û–†–Ø–î–ö–û–í–û–ì–û ID ---
    async function initIdentity() {
        let savedID = localStorage.getItem('messenger_user_num');
        
        if (!savedID) {
            status.innerText = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ ID...";
            const counterRef = db.ref('usersCount');
            const result = await counterRef.transaction(current => (current || 0) + 1);
            savedID = (result.snapshot.val() - 1).toString();
            localStorage.setItem('messenger_user_num', savedID);
        }
        
        myIdDisplay.innerText = savedID;
        startPeer(savedID);
    }

    // --- 4. –ó–ê–ü–£–°–ö –°–í–Ø–ó–ò ---
    function startPeer(idNum) {
        status.innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏...";
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ—Ñ–∏–∫—Å, —á—Ç–æ–±—ã PeerJS –±—ã–ª–æ –ø—Ä–æ—â–µ —Ä–∞–±–æ—Ç–∞—Ç—å
        peer = new Peer('messenger-app-' + idNum);

        peer.on('open', () => {
            status.innerText = "–í —Å–µ—Ç–∏. –ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫—É.";
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
        peer.on('call', call => {
            ringtone.play();
            if (confirm("–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è! –û—Ç–≤–µ—Ç–∏—Ç—å?")) {
                ringtone.pause();
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    localStream = stream;
                    call.answer(stream);
                    handleCall(call);
                });
            } else {
                ringtone.pause();
                call.close();
            }
        });
    }

    // –õ–æ–≥–∏–∫–∞ –∏—Å—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
    callBtn.onclick = () => {
        const targetId = friendIdInput.value;
        if (!targetId) return alert("–í–≤–µ–¥–∏—Ç–µ ID!");

        status.innerText = "–í—ã–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è " + targetId + "...";
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            localStream = stream;
            const call = peer.call('messenger-app-' + targetId, stream);
            handleCall(call);
        });
    };

    function handleCall(call) {
        currentCall = call;
        call.on('stream', remoteStream => {
            remoteAudio.srcObject = remoteStream;
            status.innerText = "–†–∞–∑–≥–æ–≤–æ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω";
            callBtn.style.display = 'none';
            hangupBtn.style.display = 'block';
        });

        call.on('close', () => {
            location.reload(); // –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        });
    }

    hangupBtn.onclick = () => {
        if (currentCall) currentCall.close();
        location.reload();
    };

    // –ó–∞–ø—É—Å–∫ –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
    initIdentity().catch(err => {
        console.error(err);
        status.innerText = "–û—à–∏–±–∫–∞ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥!";
    });

</script>
</body>
</html>
