<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Audio Messenger</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #eceff1; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .my-id { color: #007bff; font-weight: bold; font-size: 1.2em; margin-bottom: 15px; }
        input { width: 80%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 85%; margin: 5px; }
        .btn-join { background: #007bff; color: white; }
        .btn-exit { background: #dc3545; color: white; display: none; }
        #status { font-size: 0.9em; color: #555; margin-top: 15px; }
        #participants { margin-top: 10px; font-size: 0.8em; color: #888; }
    </style>
</head>
<body>

<div class="card">
    <h2>–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</h2>
    <div class="my-id">–í–∞—à ID: <span id="my-id-val">...</span></div>
    
    <input type="number" id="room-input" placeholder="–ù–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä. 10)">
    
    <button id="join-btn" class="btn btn-join">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É üéß</button>
    <button id="exit-btn" class="btn btn-exit">–í—ã–π—Ç–∏ ‚ùå</button>

    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="participants">–í –∫–æ–º–Ω–∞—Ç–µ: 0</div>
</div>

<div id="remote-audios"></div>

<script>
    // --- –ö–û–ù–§–ò–ì FIREBASE (–í—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π!) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAYzOcE7_ALO5xSJF-sq48Fc2YKgRdERDE",
        databaseURL: "https://dombase-1cbd8-default-rtdb.firebaseio.com",
        projectId: "dombase-1cbd8",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const el = {
        myId: document.getElementById('my-id-val'),
        roomInput: document.getElementById('room-input'),
        joinBtn: document.getElementById('join-btn'),
        exitBtn: document.getElementById('exit-btn'),
        status: document.getElementById('status'),
        participants: document.getElementById('participants'),
        remoteContainer: document.getElementById('remote-audios')
    };

    let peer, localStream, myUserNum, currentRoom;
    let peersInRoom = {}; // –•—Ä–∞–Ω–∏–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–≤–æ–Ω–∫–∏

    // 1. –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π ID
    async function init() {
        let savedID = localStorage.getItem('messenger_user_num');
        if (!savedID) {
            const result = await db.ref('usersCount').transaction(c => (c || 0) + 1);
            savedID = (result.snapshot.val() - 1).toString();
            localStorage.setItem('messenger_user_num', savedID);
        }
        myUserNum = savedID;
        el.myId.innerText = myUserNum;
        
        peer = new Peer('group-app-' + myUserNum);
        peer.on('open', () => el.status.innerText = "–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é");
        
        // –°–ª—É—à–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã
        peer.on('call', call => {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                call.answer(stream);
                handleCall(call);
            });
        });
    }

    // 2. –í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É
    el.joinBtn.onclick = async () => {
        currentRoom = el.roomInput.value;
        if (!currentRoom) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã!");

        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–µ–±—è –≤ –∫–æ–º–Ω–∞—Ç–µ –≤ Firebase
        const roomRef = db.ref(`rooms/${currentRoom}/${myUserNum}`);
        roomRef.set(true);
        roomRef.onDisconnect().remove(); // –£–¥–∞–ª–∏—Ç—å –Ω–∞—Å, –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –∑–∞–∫—Ä–æ–µ—Ç—Å—è

        // –°–ª–µ–¥–∏–º –∑–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∫–æ–º–Ω–∞—Ç—ã
        db.ref(`rooms/${currentRoom}`).on('value', snapshot => {
            const users = snapshot.val() || {};
            const ids = Object.keys(users);
            el.participants.innerText = "–í –∫–æ–º–Ω–∞—Ç–µ: " + ids.length;

            ids.forEach(userId => {
                if (userId !== myUserNum && !peersInRoom[userId]) {
                    // –ó–≤–æ–Ω–∏–º –Ω–æ–≤–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É
                    const call = peer.call('group-app-' + userId, localStream);
                    handleCall(call, userId);
                    peersInRoom[userId] = true;
                }
            });
        });

        el.joinBtn.style.display = 'none';
        el.exitBtn.style.display = 'block';
        el.status.innerText = "–í—ã –≤ –∫–æ–º–Ω–∞—Ç–µ " + currentRoom;
    };

    function handleCall(call, userId) {
        call.on('stream', remoteStream => {
            if (!document.getElementById('audio-' + call.peer)) {
                const audio = document.createElement('audio');
                audio.id = 'audio-' + call.peer;
                audio.srcObject = remoteStream;
                audio.autoplay = true;
                el.remoteContainer.appendChild(audio);
            }
        });
    }

    el.exitBtn.onclick = () => location.reload();

    init();
</script>
</body>
</html>
